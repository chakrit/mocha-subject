<!DOCTYPE html><html lang="en"><head><title>index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="index"><meta name="groc-project-path" content="lib/subject.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">lib/subject.js</div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments"><div class="wrapper"><p>subject.js - Subject-style setups/teardowns.</p></div></div><div class="code"><div class="wrapper"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">$S</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span> <span class="c1">// main exports</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-infections-list">_infections list</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Array of function names to adds to <code>global</code> when <code>infect()</code> is called.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$S</span><span class="p">.</span><span class="nx">_infections</span> <span class="o">=</span> <span class="s1">&#39;subject,property&#39;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="-before-func--and-after-func--hook">_before( func ) and _after( func ) hook</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Helper function that adds the supplied function to the <code>before()</code> and <code>after()</code> hook
provided by mocha. This is provided in case you want to override the behavior of the
<code>before()</code> and <code>after()</code> hook that is used by mocha-subject.</p>

<p><strong>NOTE:</strong> Mocha rebuilds its <code>before()</code> and <code>after()</code> function after every test run
so you must take care not to capture these variables and re-use it across different
run of the test because it will produce unpredictable result. These two functions
also helps in this regard. (Re-retreiving the value of <code>global.before</code> and
<code>global.after</code> hook after every run.)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$S</span><span class="p">.</span><span class="nx">_before</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="nx">func</span><span class="p">);</span> <span class="p">};</span>
  <span class="nx">$S</span><span class="p">.</span><span class="nx">_after</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">after</span><span class="p">(</span><span class="nx">func</span><span class="p">);</span> <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="infect">infect()</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Adds <code>subject()</code> and <code>property()</code> method to global scope so it can be used without
referencing mocha-subject.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$S</span><span class="p">.</span><span class="nx">infect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">$S</span><span class="p">.</span><span class="nx">_infections</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">global</span><span class="p">[</span><span class="nx">$S</span><span class="p">.</span><span class="nx">_infections</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">$S</span><span class="p">[</span><span class="nx">$S</span><span class="p">.</span><span class="nx">_infections</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="disinfect">disinfect()</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Removes all functions added by <code>infect()</code> from global scope.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$S</span><span class="p">.</span><span class="nx">disinfect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">$S</span><span class="p">.</span><span class="nx">_infections</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
      <span class="k">delete</span> <span class="nx">global</span><span class="p">[</span><span class="nx">$S</span><span class="p">.</span><span class="nx">_infections</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="subject-name-object-">subject( name, object )</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Adds the given <code>object</code> to current mocha test context using the specified name in a
<code>before</code> hook and removes it afterwards in an <code>after</code> hook.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$S</span><span class="p">.</span><span class="nx">subject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;name argument missing or not a string&#39;</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">object</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">,</span> <span class="s1">&#39;object argument is undefined&#39;</span><span class="p">);</span>

    <span class="nx">$S</span><span class="p">.</span><span class="nx">_before</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">object</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>TODO: Is there a way to track subjects hierarchy without modifying the context?
  storing states ourselves is probably not a good idea.</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__subjects</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;__subjects&#39;</span><span class="p">,</span>
          <span class="p">{</span> <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">,</span> <span class="nx">configurable</span><span class="o">:</span> <span class="kc">true</span> <span class="c1">// required for delete</span>
          <span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">[]</span> <span class="p">});</span>
      <span class="p">}</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">__subjects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">$S</span><span class="p">.</span><span class="nx">_after</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">__subjects</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__subjects</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">__subjects</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="property-name-key-">property( name, [key] )</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Take property <code>name</code> from the nearest subject object and adds it to current mocha
test context using the specified <code>key</code> (or the same name as the property if <code>key</code> is
not specified.)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$S</span><span class="p">.</span><span class="nx">property</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">contextKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;name argument missing or not a string&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">contextKey</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="nx">contextKey</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">contextKey</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;contextKey argument not a string&#39;</span><span class="p">);</span>

    <span class="nx">$S</span><span class="p">.</span><span class="nx">_before</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">subject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__subjects</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">__subjects</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

      <span class="k">this</span><span class="p">[</span><span class="nx">contextKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="p">});</span>

    <span class="nx">$S</span><span class="p">.</span><span class="nx">_after</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">contextKey</span><span class="p">];</span> <span class="p">});</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="nx">$S</span><span class="p">;</span>

<span class="p">})();</span></div></div></div></div></body></html>